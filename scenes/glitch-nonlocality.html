<!-- htmlhint doctype-first:false -->
<section class="scene full-bleed" data-scene="nonlocality">
  <style>
    .scene.full-bleed{position:relative;inset:0;display:block;min-height:calc(100vh - 64px)}
    .panel{position:absolute;left:1rem;top:1rem;display:flex;gap:1rem;flex-wrap:wrap;
      background:rgba(0,0,0,.4);backdrop-filter:blur(6px);padding:1rem;border-radius:.8rem}
    .panel label{font:600 13px/1.2 system-ui;display:flex;gap:.5rem;align-items:center}
    .row{display:flex;gap:.5rem;align-items:center}
    .val{display:inline-block;min-width:3rem;text-align:right}
    .chip{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:rgba(255,255,255,.08);font:12px/1.2 system-ui}
    canvas{position:absolute;inset:0;width:100%;height:100%}
    .legend{position:absolute;right:1rem;top:1rem;display:flex;gap:.5rem;align-items:center;opacity:.85}
    .bar{width:12px;height:12px;border-radius:3px;display:inline-block}
    .note{position:absolute;right:1rem;bottom:3.5rem;opacity:.75;font:12px/1.2 system-ui}
    .done{position:absolute;right:1rem;bottom:1rem}
    .btn{border:0;border-radius:.6rem;padding:.6rem 1rem;background:#1f6feb;color:#fff;font:600 14px/1;cursor:pointer}
  </style>

  <div class="panel">
    <div class="row">
      <label><input type="radio" name="model" value="lhv" checked> LHV</label>
      <label><input type="radio" name="model" value="qm"> QM</label>
      <span class="chip" id="sval">S = —</span>
    </div>
    <div class="row"><label>a:  <input type="range" id="a"  min="-90" max="90" step="1" value="0"></label>  <span class="val" id="av">0°</span></div>
    <div class="row"><label>a′: <input type="range" id="ap" min="-90" max="90" step="1" value="45"></label> <span class="val" id="apv">45°</span></div>
    <div class="row"><label>b:  <input type="range" id="b"  min="-90" max="90" step="1" value="22"></label> <span class="val" id="bv">22°</span></div>
    <div class="row"><label>b′: <input type="range" id="bp" min="-90" max="90" step="1" value="-22"></label><span class="val" id="bpv">-22°</span></div>
  </div>

  <div class="legend"><span class="bar" style="background:#9ad1ff"></span> QM  <span class="bar" style="background:#ffb86c;margin-left:.75rem"></span> LHV</div>
  <canvas id="plot"></canvas>
  <div class="note">CHSH: S = |E(a,b) + E(a,b′) + E(a′,b) − E(a′,b′)|. LHV ≤ 2, QM ≤ 2√2.</div>
  <div class="done"><button class="btn" id="finish">Завершить сцену</button></div>

  <script>
  (function(){
    const root=document.currentScript.closest('[data-scene="nonlocality"]');
    const cvs=root.querySelector('#plot'), ctx=cvs.getContext('2d',{alpha:false});
    const sval=root.querySelector('#sval'), finish=root.querySelector('#finish');
    const inputs=['a','ap','b','bp'].map(id=>root.querySelector('#'+id));
    const vals=['av','apv','bv','bpv'].map(id=>root.querySelector('#'+id));
    let model='lhv';

    root.querySelectorAll('input[name="model"]').forEach(r=>r.addEventListener('change',e=>{model=e.target.value;draw();}));
    inputs.forEach((el,i)=>el.addEventListener('input',()=>{vals[i].textContent=el.value+'°';draw();}));

    function fit(){
      const dpr=Math.max(1,devicePixelRatio||1);
      const w=root.clientWidth||960, h=root.clientHeight||560;
      cvs.width=Math.floor(w*dpr); cvs.height=Math.floor(h*dpr);
      cvs.style.width=w+'px'; cvs.style.height=h+'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    function E_qm(deg){const x=deg*Math.PI/180;return -Math.cos(x);}
    // упрощённая LHV-аппроксимация, гарантирует S<=2
    function E_lhv(deg){
      const x=Math.abs((deg%180+180)%180);
      const u=(x>90)?180-x:x;
      const e=1-(4*u/180);
      return Math.max(-1,Math.min(1,e));
    }
    function E(a,b){const d=a-b;return (model==='qm')?E_qm(d):E_lhv(d);}

    function draw(){
      const W=cvs.width/(devicePixelRatio||1), H=cvs.height/(devicePixelRatio||1);
      ctx.fillStyle='#0a0f1a'; ctx.fillRect(0,0,W,H);
      const a=+inputs[0].value, ap=+inputs[1].value, b=+inputs[2].value, bp=+inputs[3].value;

      const S=Math.abs(E(a,b)+E(a,bp)+E(ap,b)-E(ap,bp));
      const S_QM=Math.abs(E_qm(a-b)+E_qm(a-bp)+E_qm(ap-b)-E_qm(ap-bp));
      const S_LHV=Math.abs(E_lhv(a-b)+E_lhv(a-bp)+E_lhv(ap-b)-E_lhv(ap-bp));
      sval.textContent='S = '+S.toFixed(3);

      const pad=64, X0=pad, X1=W-pad, Y0=H-pad, Y1=pad, maxS=3;
      ctx.strokeStyle='rgba(255,255,255,.22)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(X0,Y0); ctx.lineTo(X1,Y0); ctx.moveTo(X0,Y0); ctx.lineTo(X0,Y1); ctx.stroke();

      const y2=Y0-(2/maxS)*(Y0-Y1), yTs=Y0-((2*Math.SQRT2)/maxS)*(Y0-Y1);
      ctx.setLineDash([6,5]); ctx.strokeStyle='rgba(255,255,255,.28)';
      ctx.beginPath(); ctx.moveTo(X0,y2); ctx.lineTo(X1,y2); ctx.moveTo(X0,yTs); ctx.lineTo(X1,yTs); ctx.stroke();
      ctx.setLineDash([]);

      const bw=60, cx=X0+120;
      function bar(x,val,color){const y=Y0-(val/maxS)*(Y0-Y1); ctx.fillStyle=color; ctx.fillRect(x-bw/2,y,bw,Y0-y);
        ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.fillText(val.toFixed(3),x,y-6);}
      bar(cx,S_QM,'#9ad1ff'); bar(cx+110,S_LHV,'#ffb86c');

      ctx.fillText('QM',cx,Y0+18); ctx.fillText('LHV',cx+110,Y0+18);
    }

    function onMount(){fit(); inputs.forEach((el,i)=>vals[i].textContent=el.value+'°'); draw(); window.addEventListener('resize',()=>{fit(); draw();});}
    function onUnmount(){window.removeEventListener('resize',fit);}

    finish.addEventListener('click',()=>{try{window.Progress?.markDone?.('nonlocality')}catch{};finish.textContent='Готово ✓';finish.disabled=true;});

    if(window.SceneFrame?.register){window.SceneFrame.register(root,{onMount,onUnmount});} else {onMount();}
  })();
  </script>
</section>
