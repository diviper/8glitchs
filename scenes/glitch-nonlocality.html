<!-- htmlhint doctype-first:false -->
<section class="scene full-bleed" data-scene="nonlocality">
  <style>
    .scene.full-bleed{position:relative;inset:0;display:block;min-height:calc(100vh - 64px)}
    .panel{position:absolute;left:1rem;top:1rem;display:flex;gap:1rem;flex-wrap:wrap;
      background:rgba(0,0,0,.4);backdrop-filter:blur(6px);padding:1rem;border-radius:.8rem}
    .panel label{font:600 13px/1.2 system-ui;display:flex;gap:.5rem;align-items:center}
    .row{display:flex;gap:.5rem;align-items:center}
    .val{display:inline-block;min-width:3.2rem;text-align:right}
    .chip{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:rgba(255,255,255,.08);font:12px/1.2 system-ui}
    canvas{position:absolute;inset:0;width:100%;height:100%}
    .legend{position:absolute;right:1rem;top:1rem;display:flex;gap:.5rem;align-items:center;opacity:.8}
    .bar{width:12px;height:12px;border-radius:3px;display:inline-block}
    .note{position:absolute;right:1rem;bottom:3.5rem;opacity:.75;font:12px/1.2 system-ui}
    .done{position:absolute;right:1rem;bottom:1rem}
    .btn{border:0;border-radius:.6rem;padding:.6rem 1rem;background:#1f6feb;color:#fff;font:600 14px/1;cursor:pointer}
  </style>

  <div class="panel" data-ui>
    <div class="row">
      <label><input type="radio" name="model" value="lhv" checked> LHV</label>
      <label><input type="radio" name="model" value="qm"> QM</label>
      <span class="chip" id="sval">S = —</span>
    </div>
    <div class="row"><label>a: <input type="range" id="a" min="-90" max="90" step="1" value="0"></label><span class="val" id="av">0°</span></div>
    <div class="row"><label>a′: <input type="range" id="ap" min="-90" max="90" step="1" value="45"></label><span class="val" id="apv">45°</span></div>
    <div class="row"><label>b: <input type="range" id="b" min="-90" max="90" step="1" value="22"></label><span class="val" id="bv">22°</span></div>
    <div class="row"><label>b′: <input type="range" id="bp" min="-90" max="90" step="1" value="-22"></label><span class="val" id="bpv">-22°</span></div>
  </div>

  <div class="legend"><span class="bar" style="background:#9ad1ff"></span> QM  <span class="bar" style="background:#ffb86c;margin-left:.75rem"></span> LHV</div>
  <canvas id="plot"></canvas>
  <div class="note">CHSH: S = |E(a,b) + E(a,b′) + E(a′,b) − E(a′,b′)|. LHV ≤ 2, QM ≤ 2√2.</div>
  <div class="done"><button class="btn" id="finish">Завершить сцену</button></div>

  <script>
  (function(){
    const root = document.currentScript.closest('[data-scene="nonlocality"]');
    const cvs = root.querySelector('#plot'); const ctx = cvs.getContext('2d', { alpha:false });
    const sval = root.querySelector('#sval'); const finish = root.querySelector('#finish');
    const inputs = ['a','ap','b','bp'].map(id => root.querySelector('#'+id));
    const vals = ['av','apv','bv','bpv'].map(id => root.querySelector('#'+id));
    let model = 'lhv', raf=0;

    root.querySelectorAll('input[name="model"]').forEach(r => r.addEventListener('change', e => { model = e.target.value; draw(); }));

    inputs.forEach((el, i) => el.addEventListener('input', () => {
      vals[i].textContent = el.value + '°';
      draw();
    }));

    function fit(){
      const dpr = Math.max(1, devicePixelRatio||1);
      const w = root.clientWidth || 960, h = root.clientHeight || 560;
      cvs.width = Math.floor(w*dpr); cvs.height = Math.floor(h*dpr);
      cvs.style.width = w+'px'; cvs.style.height = h+'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    // модели корреляций
    function E_qm(deg){ const x = deg*Math.PI/180; return -Math.cos(x); }
    // простая «треугольная» LHV аппроксимация: период π, без нарушения CHSH
    function E_lhv(deg){
      const x = Math.abs((deg%180+180)%180); // [0,180)
      const u = (x>90)? 180-x : x; // [0,90]
      // линейная аппроксимация (E≈1-4u/π) ограниченная [-1,1]
      const e = 1 - (4*u/180)*Math.PI; // грубо, но даёт S<=2 для стандартных наборов углов
      return Math.max(-1, Math.min(1, e));
    }

    function E(a,b){ const d = (a-b); return (model==='qm')? E_qm(d) : E_lhv(d); }

    function draw(){
      cancelAnimationFrame(raf); raf = requestAnimationFrame(_draw);
    }

    function _draw(){
      const W = cvs.width/(devicePixelRatio||1), H = cvs.height/(devicePixelRatio||1);
      ctx.fillStyle = '#0a0f1a'; ctx.fillRect(0,0,W,H);

      const a=+inputs[0].value, ap=+inputs[1].value, b=+inputs[2].value, bp=+inputs[3].value;

      const s = Math.abs(E(a,b) + E(a,bp) + E(ap,b) - E(ap,bp));
      const sQM = Math.abs((-Math.cos((a-b)*Math.PI/180)) + (-Math.cos((a-bp)*Math.PI/180)) + (-Math.cos((ap-b)*Math.PI/180)) - (-Math.cos((ap-bp)*Math.PI/180)));
      const sLHV= (()=>{ const old=model; model='lhv'; const v=Math.abs(E(a,b)+E(a,bp)+E(ap,b)-E(ap,bp)); model=old; return v; })();

      sval.textContent = 'S = ' + s.toFixed(3);

      // оси
      const pad = 64; const X0 = pad; const X1 = W-pad; const Y0 = H-pad; const Y1= pad;
      ctx.strokeStyle = 'rgba(255,255,255,.2)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(X0,Y0); ctx.lineTo(X1,Y0); ctx.moveTo(X0,Y0); ctx.lineTo(X0,Y1); ctx.stroke();

      // направляющие уровни 2 и 2√2
      const maxS = 3; const y2 = Y0 - (2/maxS)*(Y0-Y1); const ymax = Y0 - ((2*Math.SQRT2)/maxS)*(Y0-Y1);
      ctx.setLineDash([5,4]); ctx.strokeStyle='rgba(255,255,255,.25)';
      ctx.beginPath(); ctx.moveTo(X0,y2); ctx.lineTo(X1,y2); ctx.moveTo(X0,ymax); ctx.lineTo(X1,ymax); ctx.stroke();
      ctx.setLineDash([]);

      // столбики S_QM и S_LHV
      const bw = 60; const cx = X0+100;
      function bar(x, val, color){
        const y = Y0 - (val/maxS)*(Y0-Y1);
        ctx.fillStyle=color; ctx.fillRect(x-bw/2, y, bw, Y0-y);
        ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='12px system-ui'; ctx.textAlign='center';
        ctx.fillText(val.toFixed(3), x, y - 6);
      }
      bar(cx, sQM, '#9ad1ff'); bar(cx+100, sLHV, '#ffb86c');

      // подписи осей
      ctx.fillStyle='rgba(255,255,255,.7)'; ctx.font='12px system-ui'; ctx.textAlign='left';
      ctx.fillText('S', X0+6, Y1+12);
      ctx.textAlign='center'; ctx.fillText('QM', cx, Y0+18); ctx.fillText('LHV', cx+100, Y0+18);
    }

    finish.addEventListener('click', () => {
      try { window.Progress?.markDone?.('nonlocality'); } catch(e){}
      finish.textContent='Готово ✓'; finish.disabled=true;
    });

    function onMount(){ fit(); inputs.forEach((el,i)=> vals[i].textContent = el.value+'°'); draw(); window.addEventListener('resize', ()=>{fit(); draw();}); }
    function onUnmount(){ cancelAnimationFrame(raf); window.removeEventListener('resize', fit); }

    if (window.SceneFrame && typeof window.SceneFrame.register === 'function') {
      window.SceneFrame.register(root, { onMount, onUnmount });
    } else { onMount(); }
  })();
  </script>
</section>
