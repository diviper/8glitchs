<section class="scene full-bleed" data-scene="mind-uploading">
  <style>
    .scene.full-bleed{display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--color-background)}
    .brains{display:flex;gap:2rem;margin-bottom:2rem}
    .brain{width:200px;height:200px;border:2px solid var(--color-border);border-radius:1rem;position:relative;background:var(--color-surface)}
    .brain .title{position:absolute;top:-25px;left:50%;transform:translateX(-50%);color:var(--color-text-muted)}
    .brain canvas{width:100%;height:100%;border-radius:1rem}
    .controls{text-align:center}
    .status{margin-bottom:1rem;min-height:1.5em;font-size:1.1rem;color:var(--color-secondary)}
    .done{position:absolute;right:1rem;bottom:1rem}
  </style>

  <div class="brains">
    <div class="brain">
      <div class="title">Оригинал</div>
      <canvas id="brain-original"></canvas>
    </div>
    <div class="brain">
      <div class="title">Копия</div>
      <canvas id="brain-copy"></canvas>
    </div>
  </div>
  <div class="controls">
    <div id="status" class="status">Нажмите, чтобы начать сканирование...</div>
    <button id="upload-btn" class="btn">СКАНИРОВАТЬ</button>
  </div>
  <div class="done"><button id="finish" class="btn">Завершить сцену</button></div>

  <script>
  (function(){
    const root = document.currentScript.closest('[data-scene="mind-uploading"]');
    const statusEl=root.querySelector('#status'), uploadBtn=root.querySelector('#upload-btn'), finishBtn=root.querySelector('#finish');
    const canvasOrig = root.querySelector('#brain-original'), ctxOrig = canvasOrig.getContext('2d');
    const canvasCopy = root.querySelector('#brain-copy'), ctxCopy = canvasCopy.getContext('2d');

    let nodes = [];
    const nodeCount = 50;

    function initBrain(ctx, w, h){
      ctx.fillStyle = '#0d0221';
      ctx.fillRect(0, 0, w, h);
      nodes = [];
      for(let i=0; i<nodeCount; i++) {
        nodes.push({
          x: Math.random()*w, y: Math.random()*h,
          vx: Math.random()*2-1, vy: Math.random()*2-1,
        });
      }
    }

    function drawBrain(ctx, w, h) {
      ctx.fillStyle = 'rgba(13, 2, 33, 0.2)';
      ctx.fillRect(0, 0, w, h);
      ctx.strokeStyle = '#f92f60';
      ctx.lineWidth = 0.5;

      nodes.forEach(n => {
        n.x += n.vx; n.y += n.vy;
        if(n.x<0||n.x>w) n.vx*=-1;
        if(n.y<0||n.y>h) n.vy*=-1;

        nodes.forEach(n2 => {
          const dist = Math.hypot(n.x-n2.x, n.y-n2.y);
          if (dist < 100) {
            ctx.beginPath();
            ctx.moveTo(n.x, n.y);
            ctx.lineTo(n2.x, n2.y);
            ctx.stroke();
          }
        });
      });
      requestAnimationFrame(() => drawBrain(ctx, w, h));
    }

    function startUpload() {
      uploadBtn.disabled = true;
      let progress = 0;
      ctxCopy.clearRect(0,0,300,300);

      const interval = setInterval(() => {
        progress += 5;
        statusEl.textContent = `Сканирование... ${progress}%`;

        ctxCopy.fillStyle = '#0d0221';
        ctxCopy.fillRect(0,0,300,300);
        ctxCopy.drawImage(canvasOrig, 0, 0, 300 * (progress/100), 300);

        if (progress >= 100) {
          clearInterval(interval);
          statusEl.textContent = 'Загрузка завершена. Кто из них теперь "ВЫ"?';
        }
      }, 100);
    }

    function onMount(){
      [canvasOrig, canvasCopy].forEach(c => {c.width=300;c.height=300;});
      initBrain(ctxOrig, 300, 300);
      drawBrain(ctxOrig, 300, 300);
      uploadBtn.addEventListener('click', startUpload);
    }

    function onUnmount() { uploadBtn.removeEventListener('click', startUpload); }
    finishBtn.addEventListener('click', () => { try { window.Progress?.markDone?.('mind-uploading')}catch(e){};finishBtn.textContent = 'Готово ✓';finishBtn.disabled = true; });
    if(window.SceneFrame?.register) { window.SceneFrame.register(root, { onMount, onUnmount }); } else { onMount(); }
  })();
  </script>
</section>
